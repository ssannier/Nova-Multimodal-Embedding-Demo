version: 0.2
# Adjust the image if needed, but a standard Python one should suffice
# Ensure your CodeBuild service role has permissions for S3, S3Vectors, S3 Control, and Bedrock
phases:
  install:
    commands:
      # Upgrade pip and install required libraries, including boto3.
      # Boto3 versions must be recent enough to support 's3vectors' and 'bedrock-runtime'
      - echo "Installing dependencies..."
      - pip install --upgrade pip
      - pip install boto3

  pre_build:
    commands:
      # Define environment variables used in your Python script
      - echo "Setting environment variables..."
      - export INPUT_BUCKET="cic-multimedia-test"
      - export VECTOR_BUCKET="cic-multimodal-embeddings"
      - export VECTOR_INDEX="embeddings"
      - export BEDROCK_MODEL_ID="amazon.nova-multimodal-embeddings-v1:0"
      - export EMBEDDING_DIMENSION="3072"
      - export S3_REGION="us-east-1" # Nova Multimodal Embeddings is in N. Virginia
      - export BATCH_ROLE_ARN="arn:aws:iam::756493389182:role/S3BatchOpsExecutionRole" 
      - export LAMBDA_ARN="arn:aws:lambda:us-east-1:756493389182:function:NovaEmbeddingProcessor"
  build:
    commands:
      # Run the main Python script that generates the manifest and starts the S3 Batch Job
      - echo "Running the vector processing job creator script..."
      - python batch_processor.py
      
artifacts:
  files:
    # Optional: include log files or a job-status file if you create one
    - 'job_details.txt'